# Настройка стека LEMP

В данном уроке научимся конфигурировать популярный стек **L**inux + **E**Nginx + **M**ySQL + **P**HP.

## Шаг 1. Nginx + PHP

Для начала нам понадобится 2 конфигурационных файла:
1) [nginx.yml](step1/k8s/nginx.yml)
2) [php-fpm.yml](step1/k8s/php-fpm.yml)

И простейший [php-скрипт](step1/core/index.php).

Ознакомьтесь с содержимым файлов и комментариями к наиболее интересным строкам.

Скачайте папку **level4/lemp/step1** на свою хост-машину.

Найдите строки с комментарием `# абсолютный путь на хост-машине к папке с файлами приложения` и убедитесь, что там указан правильный путь. Если нет, то исправьте его.

Перейдите в папку **level4/lemp/step1** и запустите стек:
```bash
microk8s kubectl apply -f k8s
```

Теперь убедимся, что все контейнеры запущены:
```bash
microk8s kubectl get pod
```

На хост машине порт 8080 связан с 80-м портом внутри контейнера Nginx. Поэтому можем проверить его работу таким образом:
```bash
curl 127.0.0.1:8080
```
В ответ получим HTML, сгенерированный файлом **index.php**:
```html
<html lang="en">
    <head>
        <title>20</title>
    </head>
    <body>
        <h1>Hello World!</h1>    
    </body>
</html>
```
Теперь можно удалить стек:
```bash
microk8s kubectl delete -f k8s
```

## Шаг 2. Добавляем MySQL

Изменения конфигурации контейнера PHP - [php-fpm.yml](step2/k8s/php-fpm.yml):

1) Для работы с MySQL из PHP необходимо будет добавить соответсвующее расширение PHP. Поэтому воспользуемся готовым образом с этим расширением - `phpprogrammist/php:8.1-fpm-dev-mysql`.
2) Добавляем команду проверки готовности контейнера `mysql`.

Добавляем файл настройки контейнера и сервиса `mysql` - [mysql.yml](step2/k8s/mysql.yml).

В нем используем Секрет, в котором закодирован пароль БД. А также команды для проверки готовности и работоспособности контейнера.

Указана также папка для хранения файлов БД, но на хост-машине ее нет - она будет создана автоматически.

В папке [core](step2/core) есть 3 файла:
1) [db.php](step2/core/db.php) - настройки подключения к БД
2) [init.php](step2/core/init.php) - создание таблицы в БД и заполнение ее тестовыми данными
3) [index.php](step2/core/index.php) - запрос данных из БД и вывод их в виде таблицы

Скачайте папку **level4/lemp/step2** на свою хост-машину.

Найдите строки с комментарием `# абсолютный путь на хост-машине к папке...` и убедитесь, что там указан правильный путь. Если нет, то исправьте его.

Перейдите в папку **level4/lemp/step2** и запустите стек:
```bash
microk8s kubectl apply -f k8s
```

Ждем, пока все контейнеры не будут запущены:
```bash
microk8s kubectl get pod
```

Запускам скрипт инициализации БД:
```bash
curl 127.0.0.1:8080/init.php
```

А после этого обращаемся к индексному файлу, который выведет таблицу с тестовыми данными из БД:
```bash
curl 127.0.0.1:8080
```

Теперь можно удалить стек:
```bash
microk8s kubectl delete -f k8s
```
